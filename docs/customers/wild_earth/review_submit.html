<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Review</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #1a1a1a;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .product-review-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            background: #fafafa;
        }

        .product-review-section.collapsed .review-form-content {
            display: none;
        }

        .product-review-section.expanded .review-form-content {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }

        .product-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .product-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
            color: #1a1a1a;
        }

        .product-info a {
            color: #0066cc;
            text-decoration: none;
            font-size: 14px;
        }

        .product-info a:hover {
            text-decoration: underline;
        }

        .rating-section {
            margin-bottom: 25px;
        }

        .overall-rating-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .overall-rating-section .rating-label {
            font-size: 18px;
            font-weight: 700;
        }

        .attribute-ratings-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .rating-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 15px;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .star {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            display: inline-block;
            width: 42px;
            height: 42px;
            position: relative;
            margin-right: 4px;
        }

        .star svg {
            width: 100%;
            height: 100%;
            transition: all 0.2s;
        }

        .star:hover {
            transform: scale(1.15);
        }

        .review-text-section {
            margin-bottom: 25px;
        }

        .review-text-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 15px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #0066cc;
        }

        .voice-input-btn {
            display: none;
            margin-top: 10px;
            padding: 8px 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            align-items: center;
            gap: 8px;
        }

        .voice-input-btn.visible {
            display: inline-flex;
        }

        .voice-input-btn.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .media-upload-section {
            margin-bottom: 25px;
        }

        .media-upload-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 15px;
        }

        .media-upload-hint {
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
        }

        .media-upload-area {
            border: 2px dashed #ddd;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .media-upload-area:hover {
            border-color: #0066cc;
            background: #f0f7ff;
        }

        .media-upload-area.dragover {
            border-color: #0066cc;
            background: #e6f2ff;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .upload-hint {
            color: #999;
            font-size: 12px;
        }

        input[type="file"] {
            display: none;
        }

        .media-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .media-preview {
            position: relative;
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .media-preview img,
        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            line-height: 1;
        }

        .media-preview .remove-btn:hover {
            background: rgba(220, 53, 69, 0.9);
        }

        .media-preview .file-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            font-size: 11px;
            text-align: center;
        }

        .error-message {
            color: #dc3545;
            font-size: 13px;
            margin-top: 5px;
        }

        .submit-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .submit-btn:hover:not(:disabled) {
            background: #0052a3;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1000;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .product-header {
                flex-direction: column;
                text-align: center;
            }

            .product-image {
                width: 100px;
                height: 100px;
            }

            .star {
                width: 48px;
                height: 48px;
            }

            .voice-input-btn {
                display: inline-flex;
            }

            .attribute-ratings-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .media-preview-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Share your experience</h1>
        <p class="subtitle">Help others by sharing your honest feedback about your purchase</p>

        <form id="reviewForm">
            <!-- Product Review Sections will be dynamically generated -->
            <!-- Dummy data structure matching API response -->
        </form>

        <div class="submit-section">
            <button type="submit" form="reviewForm" class="submit-btn" id="submitBtn">
                Submit Reviews
            </button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Dummy invitation data matching API response structure
        const dummyInvitationData = {
            invitationToken: "abc123xyz789",
            accountId: "acc_12345",
            orderId: "ord_67890",
            products: [
                {
                    productUrl: "https://www.wildearth.com.au/buy/salomon-mens-pulsar-black-white-cherry-tomato-10/L47975400-10",
                    imageUrl: "https://www.wildearth.com.au/assets/full/L47975400.webp?20250716152133",
                    name: "Salomon Pulsar Mens Trail Running Shoes - US10",
                    sku: "L47975400-10",
                    skuBase: "L47975400",
                    id: "L47975400-10",
                    mpn: "198720092297",
                    brand: "Salomon"
                },
                {
                    productUrl: "https://www.wildearth.com.au/buy/wild-earth-running-socks-original-crew-red-osfm/WE-CREWSOCK-RED",
                    imageUrl: "https://www.wildearth.com.au/assets/full/WE-CREWSOCK-RED.webp?20250519143037",
                    name: "Wild Earth Original Crew Running Socks - Red",
                    sku: "WE-CREWSOCK-RED",
                    skuBase: "WE-CREWSOCK",
                    id: "WE-CREWSOCK-RED",
                    brand: "Wild Earth"
                }
            ],
            locale: "en-US",
            redirectUri: "https://example.com/thank-you",
            reviewerEmail: "customer@example.com",
            reviewerName: "John Doe",
            expiresAt: "2024-12-31T23:59:59Z",
            isUsed: false,
            isExpired: false
        };

        // Initialize form with dummy data
        function initializeForm() {
            const form = document.getElementById('reviewForm');
            
            dummyInvitationData.products.forEach((product, index) => {
                const productSection = createProductReviewSection(product, index);
                form.appendChild(productSection);
            });
        }

        function createProductReviewSection(product, index) {
            const section = document.createElement('div');
            section.className = 'product-review-section collapsed';
            section.dataset.productIndex = index;
            section.dataset.productSku = product.sku;

            section.innerHTML = `
                <div class="product-header">
                    <img src="${product.imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <a href="${product.productUrl}" target="_blank">View Product â†’</a>
                    </div>
                </div>

                <div class="overall-rating-section">
                    <div class="rating-label">Overall Rating *</div>
                    <div class="star-rating" data-rating-type="overall" data-product-index="${index}" id="overallRating_${index}">
                        ${createStars(5, 'overall-' + index)}
                    </div>
                </div>

                <div class="review-form-content">
                    <div class="rating-section">
                        <div class="attribute-ratings-container">
                            <div>
                                <div class="rating-label">Quality</div>
                                <div class="star-rating" data-rating-type="quality" data-product-index="${index}">
                                    ${createStars(5, 'quality-' + index)}
                                </div>
                            </div>
                            <div>
                                <div class="rating-label">Value</div>
                                <div class="star-rating" data-rating-type="value" data-product-index="${index}">
                                    ${createStars(5, 'value-' + index)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="review-text-section">
                        <div class="review-text-label">Your Review</div>
                        <textarea 
                            name="reviewText_${index}" 
                            id="reviewText_${index}" 
                            placeholder="Share your experience with this product..."
                            rows="5"
                        ></textarea>
                        <button type="button" class="voice-input-btn" id="voiceBtn_${index}" onclick="startVoiceInput(${index})">
                            <span>ðŸŽ¤</span>
                            <span>Record Review</span>
                        </button>
                    </div>

                    <div class="media-upload-section">
                        <div class="media-upload-label">Add Photos or Videos</div>
                        <div class="media-upload-hint">Upload up to 3 files (images or videos). Max 20MB per file.</div>
                        <div class="media-upload-area" onclick="document.getElementById('fileInput_${index}').click()">
                            <div class="upload-icon">ðŸ“·</div>
                            <div class="upload-text">Click to upload or drag and drop</div>
                            <div class="upload-hint">Supports: JPG, PNG, MP4, MOV</div>
                        </div>
                        <input 
                            type="file" 
                            id="fileInput_${index}" 
                            multiple 
                            accept="image/*,video/*"
                            onchange="handleFileSelect(${index}, this.files)"
                        >
                        <div class="media-preview-container" id="mediaPreview_${index}"></div>
                        <div class="error-message" id="fileError_${index}"></div>
                    </div>
                </div>
            `;

            // Attach star rating handlers
            attachStarHandlers(section, index);

            // Add click handler to overall rating to expand/collapse
            const overallRating = section.querySelector('#overallRating_' + index);
            if (overallRating) {
                overallRating.addEventListener('click', (e) => {
                    if (e.target.classList.contains('star')) {
                        const ratingValue = parseInt(e.target.dataset.rating);
                        if (ratingValue > 0 && section.classList.contains('collapsed')) {
                            section.classList.remove('collapsed');
                            section.classList.add('expanded');
                        }
                    }
                });
            }

            return section;
        }

        function createStars(count, prefix) {
            let stars = '';
            for (let i = 1; i <= count; i++) {
                stars += `<span class="star" data-rating="${i}" data-prefix="${prefix}">
                    <svg width="42" height="42" viewBox="0 0 20 20">
                        <path fill="#ddd" opacity="1" d="M0 4C0 1.79086 1.79086 0 4 0H10V20H4C1.79086 20 0 18.2091 0 16V4Z"></path>
                        <path fill="#ddd" opacity="1" d="M20 4C20 1.79086 18.2091 0 16 0H10V20H16C18.2091 20 20 18.2091 20 16V4Z"></path>
                        <path fill="#f0f0f0" fill-rule="evenodd" clip-rule="evenodd" d="M10 13.3736L12.5949 14.7111C12.7378 14.7848 12.9006 14.8106 13.0593 14.7847C13.4681 14.718 13.7454 14.3325 13.6787 13.9237L13.2085 11.0425L15.2824 8.98796C15.3967 8.8748 15.4715 8.72792 15.4959 8.569C15.5588 8.15958 15.2779 7.77672 14.8685 7.71384L11.983 7.2707L10.6699 4.66338C10.5975 4.51978 10.481 4.40322 10.3374 4.33089C9.96742 4.14458 9.51648 4.29344 9.33017 4.66338L8.01705 7.2707L5.13157 7.71384C4.97265 7.73825 4.82577 7.81309 4.71261 7.92731C4.42109 8.22158 4.42332 8.69645 4.71759 8.98796L6.79152 11.0425L6.32131 13.9237C6.29541 14.0824 6.3212 14.2452 6.39486 14.3881C6.58464 14.7563 7.03696 14.9009 7.40514 14.7111L10 13.3736Z"></path>
                    </svg>
                </span>`;
            }
            return stars;
        }

        function attachStarHandlers(section, productIndex) {
            const starRatings = section.querySelectorAll('.star-rating');
            
            starRatings.forEach(ratingContainer => {
                const stars = ratingContainer.querySelectorAll('.star');
                const ratingType = ratingContainer.dataset.ratingType;
                
                stars.forEach((star, index) => {
                    const ratingValue = index + 1;
                    
                    star.addEventListener('click', () => {
                        setRating(ratingContainer, ratingValue, ratingType, productIndex);
                    });
                    
                    star.addEventListener('mouseenter', () => {
                        highlightStars(ratingContainer, ratingValue);
                    });
                    
                    star.addEventListener('mouseleave', () => {
                        const currentRating = getCurrentRating(ratingContainer);
                        if (currentRating > 0) {
                            highlightStars(ratingContainer, currentRating);
                        } else {
                            clearStarHighlights(ratingContainer);
                        }
                    });
                });
            });
        }

        function setRating(container, value, ratingType, productIndex) {
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, index) => {
                const svg = star.querySelector('svg');
                if (index < value) {
                    star.classList.add('active');
                    // Update SVG colors for active state
                    svg.querySelectorAll('path[fill="#ddd"]').forEach(path => {
                        path.setAttribute('fill', '#6cb530');
                    });
                    svg.querySelectorAll('path[fill="#f0f0f0"]').forEach(path => {
                        path.setAttribute('fill', 'white');
                    });
                } else {
                    star.classList.remove('active');
                    // Update SVG colors for inactive state
                    svg.querySelectorAll('path[fill="#6cb530"]').forEach(path => {
                        path.setAttribute('fill', '#ddd');
                    });
                    svg.querySelectorAll('path[fill="white"]').forEach(path => {
                        path.setAttribute('fill', '#f0f0f0');
                    });
                }
            });
            container.dataset.rating = value;

            // If overall rating is set, expand the form
            if (ratingType === 'overall' && value > 0) {
                const section = container.closest('.product-review-section');
                if (section && section.classList.contains('collapsed')) {
                    section.classList.remove('collapsed');
                    section.classList.add('expanded');
                }
            }
        }

        function highlightStars(container, value) {
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, index) => {
                const svg = star.querySelector('svg');
                if (index < value) {
                    star.classList.add('hover');
                    // Update SVG colors for hover state
                    svg.querySelectorAll('path[fill="#ddd"]').forEach(path => {
                        path.setAttribute('fill', '#6cb530');
                    });
                    svg.querySelectorAll('path[fill="#f0f0f0"]').forEach(path => {
                        path.setAttribute('fill', 'white');
                    });
                } else {
                    star.classList.remove('hover');
                    // Revert to inactive if not active
                    if (!star.classList.contains('active')) {
                        svg.querySelectorAll('path[fill="#6cb530"]').forEach(path => {
                            path.setAttribute('fill', '#ddd');
                        });
                        svg.querySelectorAll('path[fill="white"]').forEach(path => {
                            path.setAttribute('fill', '#f0f0f0');
                        });
                    }
                }
            });
        }

        function clearStarHighlights(container) {
            const stars = container.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.remove('hover');
                const svg = star.querySelector('svg');
                // Revert to current state (active or inactive)
                if (!star.classList.contains('active')) {
                    svg.querySelectorAll('path[fill="#6cb530"]').forEach(path => {
                        path.setAttribute('fill', '#ddd');
                    });
                    svg.querySelectorAll('path[fill="white"]').forEach(path => {
                        path.setAttribute('fill', '#f0f0f0');
                    });
                }
            });
        }

        function getCurrentRating(container) {
            return parseInt(container.dataset.rating) || 0;
        }

        // File upload handling
        const mediaFiles = {};

        function handleFileSelect(productIndex, files) {
            if (!mediaFiles[productIndex]) {
                mediaFiles[productIndex] = [];
            }

            const existingCount = mediaFiles[productIndex].length;
            const remainingSlots = 3 - existingCount;

            if (files.length > remainingSlots) {
                showError(productIndex, `You can only upload ${remainingSlots} more file(s). Maximum 3 files per product.`);
                return;
            }

            Array.from(files).forEach(file => {
                if (mediaFiles[productIndex].length >= 3) {
                    showError(productIndex, 'Maximum 3 files per product review.');
                    return;
                }

                // Check file size (20MB = 20 * 1024 * 1024 bytes)
                if (file.size > 20 * 1024 * 1024) {
                    showError(productIndex, `File "${file.name}" exceeds 20MB limit.`);
                    return;
                }

                mediaFiles[productIndex].push(file);
                displayMediaPreview(productIndex, file);
            });

            clearError(productIndex);
        }

        function displayMediaPreview(productIndex, file) {
            const container = document.getElementById(`mediaPreview_${productIndex}`);
            const preview = document.createElement('div');
            preview.className = 'media-preview';
            preview.dataset.fileName = file.name;

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = () => removeMedia(productIndex, preview, file);

            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                preview.appendChild(video);
            }

            preview.appendChild(removeBtn);
            preview.appendChild(fileInfo);
            container.appendChild(preview);
        }

        function removeMedia(productIndex, previewElement, file) {
            const index = mediaFiles[productIndex].indexOf(file);
            if (index > -1) {
                mediaFiles[productIndex].splice(index, 1);
            }
            previewElement.remove();
            URL.revokeObjectURL(file);
        }

        function showError(productIndex, message) {
            const errorEl = document.getElementById(`fileError_${productIndex}`);
            errorEl.textContent = message;
        }

        function clearError(productIndex) {
            const errorEl = document.getElementById(`fileError_${productIndex}`);
            errorEl.textContent = '';
        }

        // Voice input (mobile)
        let recognition = null;
        let currentTextareaIndex = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const textarea = document.getElementById(`reviewText_${currentTextareaIndex}`);
                if (textarea) {
                    textarea.value += (textarea.value ? ' ' : '') + transcript;
                }
                stopVoiceInput();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopVoiceInput();
            };

            recognition.onend = () => {
                stopVoiceInput();
            };
        }

        function startVoiceInput(productIndex) {
            if (!recognition) {
                showToast('Voice input not supported in this browser', 'error');
                return;
            }

            currentTextareaIndex = productIndex;
            const btn = document.getElementById(`voiceBtn_${productIndex}`);
            btn.classList.add('recording');
            btn.innerHTML = '<span>ðŸ”´</span><span>Recording...</span>';

            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                stopVoiceInput();
            }
        }

        function stopVoiceInput() {
            if (recognition && recognition.running) {
                recognition.stop();
            }

            if (currentTextareaIndex !== null) {
                const btn = document.getElementById(`voiceBtn_${currentTextareaIndex}`);
                if (btn) {
                    btn.classList.remove('recording');
                    btn.innerHTML = '<span>ðŸŽ¤</span><span>Record Review</span>';
                }
                currentTextareaIndex = null;
            }
        }

        // Form submission
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Collect form data
            const reviews = [];
            const productSections = document.querySelectorAll('.product-review-section');

            productSections.forEach((section, index) => {
                const product = dummyInvitationData.products[index];
                const overallRating = section.querySelector('[data-rating-type="overall"]').dataset.rating;
                const qualityRating = section.querySelector('[data-rating-type="quality"]').dataset.rating;
                const valueRating = section.querySelector('[data-rating-type="value"]').dataset.rating;
                const reviewText = document.getElementById(`reviewText_${index}`).value;

                if (!overallRating) {
                    showToast('Please provide an overall rating for all products', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Reviews';
                    return;
                }

                const reviewData = {
                    invitationToken: dummyInvitationData.invitationToken,
                    accountId: dummyInvitationData.accountId,
                    orderId: dummyInvitationData.orderId,
                    product: {
                        sku: product.sku,
                        skuBase: product.skuBase,
                        id: product.id,
                        name: product.name,
                        brand: product.brand
                    },
                    ratings: {
                        overall: parseInt(overallRating),
                        quality: qualityRating ? parseInt(qualityRating) : null,
                        value: valueRating ? parseInt(valueRating) : null
                    },
                    reviewText: reviewText || null,
                    mediaFiles: mediaFiles[index] || []
                };

                reviews.push(reviewData);
            });

            // TODO: Replace with actual API call
            // const response = await fetch(`https://services-staging.stacktome.com/api/reviews/v1/reviews?token=${dummyInvitationData.invitationToken}`, {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-Invitation-Token': dummyInvitationData.invitationToken
            //     },
            //     body: JSON.stringify(reviews)
            // });

            // Simulate API call
            setTimeout(() => {
                console.log('Reviews to submit:', reviews);
                showToast('Reviews submitted successfully!', 'success');
                
                // Redirect after 2 seconds
                setTimeout(() => {
                    if (dummyInvitationData.redirectUri) {
                        window.location.href = dummyInvitationData.redirectUri;
                    }
                }, 2000);
            }, 1000);
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Drag and drop handling
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();

            // Add drag and drop handlers
            document.querySelectorAll('.media-upload-area').forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    
                    const productIndex = parseInt(area.closest('.product-review-section').dataset.productIndex);
                    const files = Array.from(e.dataTransfer.files);
                    handleFileSelect(productIndex, files);
                });
            });
        });
    </script>
</body>
</html>
